# –§—É–Ω–∫—Ü–∏—è –º–∞—Å—Å–æ–≤–æ–π —Ä–∞—Å—Å—ã–ª–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π

## –û–ø–∏—Å–∞–Ω–∏–µ

Cloud Function –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –±–æ—Ç–∞, –∫–æ—Ç–æ—Ä—ã–µ —Ö–æ—Ç—å —Ä–∞–∑ –Ω–∞–∂–∏–º–∞–ª–∏ –∫–Ω–æ–ø–∫—É (–¥–∞–Ω–Ω—ã–µ –∏–∑ BigQuery).

## –î–µ–ø–ª–æ–π

```bash
./deploy-broadcast.sh
```

–ò–ª–∏ –≤—Ä—É—á–Ω—É—é:

```bash
npm run build
gcloud functions deploy broadcastMessage \
  --gen2 \
  --runtime=nodejs20 \
  --trigger-http \
  --allow-unauthenticated \
  --entry-point=broadcastMessage \
  --set-env-vars "BOT_TOKEN=$BOT_TOKEN,GOOGLE_CLOUD_PROJECT=$PROJECT_ID" \
  --region=europe-west1 \
  --source=. \
  --memory=512MB \
  --timeout=540s
```

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –¥–≤—É—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)

```bash
curl -X POST "https://YOUR-FUNCTION-URL" \
  -H "Content-Type: application/json" \
  -d '{
    "testMode": true,
    "testUserIds": [503391201, 500405387]
  }'
```

–ò–ª–∏ –ø—Ä–æ—Å—Ç–æ (testMode –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é true):

```bash
curl -X POST "https://YOUR-FUNCTION-URL" \
  -H "Content-Type: application/json" \
  -d '{}'
```

### –†–∞—Å—Å—ã–ª–∫–∞ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º (–û–°–¢–û–†–û–ñ–ù–û!)

```bash
curl -X POST "https://YOUR-FUNCTION-URL" \
  -H "Content-Type: application/json" \
  -d '{
    "testMode": false
  }'
```

## –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞

- `testMode` (boolean, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `true`): 
  - `true` - –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ç–æ–ª—å–∫–æ —Ç–µ—Å—Ç–æ–≤—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
  - `false` - –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –∏–∑ BigQuery

- `testUserIds` (number[], –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `[503391201, 500405387]`):
  - –°–ø–∏—Å–æ–∫ userId –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ `testMode: true`)

## –û—Ç–≤–µ—Ç

```json
{
  "message": "Broadcast completed",
  "testMode": true,
  "results": {
    "total": 2,
    "success": 2,
    "failed": 0,
    "errors": []
  }
}
```

## –°–æ–æ–±—â–µ–Ω–∏–µ

–¢–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏:

```
üéÑ –° –ù–æ–≤—ã–º –≥–æ–¥–æ–º! –ü—É—Å—Ç—å –≤ 2026 –±—É–¥–µ—Ç –±–æ–ª—å—à–µ –¥–≤–∏–∂–µ–Ω–∏—è –∏ —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤ üôÇ

–ú—ã –¥–æ–±–∞–≤–∏–ª–∏ –ø–µ—Ä–µ—É—Å—Ç—É–ø–∫—É –∫–æ—Ä—Ç–∞ - —Ç–µ–ø–µ—Ä—å –µ—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –∫–æ—Ä—Ç, –Ω–æ –≤—ã –Ω–µ –º–æ–∂–µ—Ç–µ —Å—ã–≥—Ä–∞—Ç—å - —Å–∫–∏–¥—ã–≤–∞–π—Ç–µ –µ–≥–æ –±–æ—Ç—É - –∏ –æ–Ω –ø—Ä–µ–¥–ª–æ–∂–∏—Ç –µ–≥–æ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º!

–ï—â—ë –æ–±–Ω–æ–≤–∏–ª–∏ –≤–∏–¥ —Å–ª–æ—Ç–æ–≤ ‚Äî –Ω–∞–¥–µ–µ–º—Å—è, —Å—Ç–∞–ª–æ –Ω–∞–≥–ª—è–¥–Ω–µ–µ)

–ü—Ä–æ–±—É–π—Ç–µ! üôå
```

–ß—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ, –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—É `NEW_YEAR_MESSAGE` –≤ —Ñ–∞–π–ª–µ `src/functions/broadcast-message.ts`.

## –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ï—Å—Ç—å –¥–≤–∞ —Å–ø–æ—Å–æ–±–∞ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –ª–æ–∫–∞–ª—å–Ω–æ:

### –°–ø–æ—Å–æ–± 1: –ü—Ä–æ—Å—Ç–æ–π —Å–∫—Ä–∏–ø—Ç (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Ç–µ—Å—Ç–∞)

```bash
# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –¥–≤—É—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
npm run test:broadcast

# –ò–ª–∏ –Ω–∞–ø—Ä—è–º—É—é
npx ts-node test-broadcast-local.ts

# –° –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
npx ts-node test-broadcast-local.ts --testMode=false
npx ts-node test-broadcast-local.ts --testUserIds=123456,789012
```

### –°–ø–æ—Å–æ–± 2: –ß–µ—Ä–µ–∑ functions-framework (–∫–∞–∫ –≤ Cloud Functions)

–≠—Ç–æ—Ç —Å–ø–æ—Å–æ–± –∑–∞–ø—É—Å–∫–∞–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é –∫–∞–∫ HTTP —Å–µ—Ä–≤–µ—Ä, –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –±–ª–∏–∑–∫–æ –∫ —Ä–µ–∞–ª—å–Ω–æ–π —Å—Ä–µ–¥–µ:

```bash
# –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
npm run build

# –ó–∞–ø—É—Å–∫ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ –ø–æ—Ä—Ç—É 8081
npm run dev:broadcast

# –ò–ª–∏ —Å –∞–≤—Ç–æ–ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–æ–π –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
npm run dev:broadcast:watch
```

–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ —Ñ—É–Ω–∫—Ü–∏—è –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ –∞–¥—Ä–µ—Å—É `http://localhost:8081`

–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ curl:

```bash
# –¢–µ—Å—Ç –Ω–∞ –¥–≤—É—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö
curl -X POST "http://localhost:8081" \
  -H "Content-Type: application/json" \
  -d '{
    "testMode": true,
    "testUserIds": [503391201, 500405387]
  }'

# –¢–µ—Å—Ç –Ω–∞ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö –∏–∑ BigQuery
curl -X POST "http://localhost:8081" \
  -H "Content-Type: application/json" \
  -d '{"testMode": false}'
```

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ `.env` —Ñ–∞–π–ª–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:
   ```
   BOT_TOKEN=your_bot_token
   GOOGLE_CLOUD_PROJECT=play-today-479819
   BIGQUERY_DATASET=telegram_bot_analytics
   BIGQUERY_TABLE=button_clicks
   USE_BIGQUERY=true
   ```

2. –î–ª—è —Ä–∞–±–æ—Ç—ã —Å BigQuery –ª–æ–∫–∞–ª—å–Ω–æ –Ω—É–∂–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è:
   ```bash
   gcloud auth application-default login
   ```

## –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- –§—É–Ω–∫—Ü–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∏ –±–æ—Ç–∞
- –ú–µ–∂–¥—É –æ—Ç–ø—Ä–∞–≤–∫–∞–º–∏ –µ—Å—Ç—å –∑–∞–¥–µ—Ä–∂–∫–∞ 50ms (20 —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Å–µ–∫—É–Ω–¥—É) –¥–ª—è —Å–æ–±–ª—é–¥–µ–Ω–∏—è rate limits Telegram API
- –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ñ—É–Ω–∫—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ç–µ—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

